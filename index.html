<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>友達チャット</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
</head>
<body>
  <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="loginModalLabel">ログイン</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <button id="twitterLogin" class="btn btn-primary w-100 mb-2"><i class="fab fa-x-twitter"></i> Xでログイン</button>
          <button id="googleLogin" class="btn btn-primary w-100 mb-2"><i class="fab fa-google"></i> Googleでログイン</button>
          <button id="anonymousLogin" class="btn btn-secondary w-100"><i class="fas fa-user-secret"></i> 匿名でログイン</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="unameModal" tabindex="-1" aria-labelledby="unameModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="unameModalLabel">ユーザー名設定</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="uname" class="form-control" placeholder="名前を入力してください" required>
          <div class="invalid-feedback">名前を入力してください。</div>
          <button id="confirmName" class="btn btn-primary w-100 mt-2">確定</button>
          <button id="signOut" class="btn btn-danger w-100 mt-2">ログアウト</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="adminLoginModal" tabindex="-1" aria-labelledby="adminLoginModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="adminLoginModalLabel">Adminログイン</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Admin権限を有効にするには、外部認証ページに移動します。</p>
          <button id="confirmAdmin" class="btn btn-primary w-100 mt-2">認証ページへ</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="confirmActionModal" tabindex="-1" aria-labelledby="confirmActionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmActionModalLabel">アクション確認</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="confirmActionMessage"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" id="confirmActionBtn" class="btn btn-primary">実行</button>
        </div>
      </div>
    </div>
  </div>

  <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">友達チャット</a>
      <div class="ms-auto d-flex align-items-center">
        <span id="user-info" class="cursor-pointer">ゲスト <i class="fas fa-pencil-alt ms-1"></i></span>
        <button id="login-btn" class="btn btn-outline-primary ms-2">ログイン</button>
      </div>
    </div>
  </nav>

  <div id="adminPanel" class="container d-none mt-4">
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h3 class="mb-0">Adminパネル</h3>
        <button id="adminLogout" class="btn btn-danger btn-sm" data-bs-toggle="tooltip" title="Adminログアウト"><i class="fas fa-sign-out-alt"></i></button>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-4">
            <h4 class="card-title">アクティブユーザー</h4>
            <div class="table-responsive">
              <table class="table table-hover table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>ユーザー名</th>
                    <th>プロバイダ</th>
                    <th>IPアドレス</th>
                    <th>アクション</th>
                  </tr>
                </thead>
                <tbody id="activeUsers"></tbody>
              </table>
            </div>
            <button id="clearAllMessages" class="btn btn-danger w-100 mt-2" data-bs-toggle="tooltip" title="すべてのメッセージをクリア"><i class="fas fa-trash-alt"></i> 全メッセージクリア</button>
          </div>
          <div class="col-md-6 mb-4">
            <h4 class="card-title">ユーザーアクション履歴</h4>
            <div class="mb-2">
              <select id="actionFilter" class="form-select">
                <option value="all">すべてのアクション</option>
                <option value="connect">接続</option>
                <option value="setUsername">ユーザー名設定</option>
                <option value="sendMessage">メッセージ送信</option>
                <option value="adminLogin">Adminログイン</option>
                <option value="adminLogout">Adminログアウト</option>
                <option value="clearAllMessages">全メッセージクリア</option>
                <option value="deleteMessage">メッセージ削除</option>
                <option value="banUser">ユーザーBAN</option>
                <option value="unbanUser">ユーザーBAN解除</option>
                <option value="kickUser">ユーザーKICK</option>
              </select>
            </div>
            <div class="table-responsive">
              <table class="table table-hover table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>ユーザー名</th>
                    <th>アクション</th>
                    <th>日時</th>
                  </tr>
                </thead>
                <tbody id="userActions"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="main-content">
    <div class="container">
      <div id="error-alert" class="alert alert-danger d-none" role="alert"></div>
      <button id="newMessageBtn" class="btn btn-primary btn-sm d-none" style="position: fixed; bottom: 120px; right: 20px; z-index: 1000;">
        <i class="fas fa-arrow-down"></i> 新着メッセージ
      </button>
      <ul id="messages" class="list-group"></ul>
    </div>
  </div>

  <footer class="bg-light fixed-bottom py-1" style="z-index: 1050;">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center">
        <span id="admin-trigger" class="cursor-pointer">DAEMON</span>
        <form id="messageForm" class="needs-validation w-100" novalidate>
          <div class="row g-2 justify-content-center align-items-center">
            <div class="col-md-10">
              <textarea id="m" class="form-control" placeholder="メッセージを入力" rows="2" autocomplete="off" required></textarea>
              <div class="invalid-feedback">メッセージを入力してください。</div>
            </div>
            <div class="col-md-2">
              <button type="submit" id="submit-btn" class="btn btn-primary btn-sm w-100">送信</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
    import { getDatabase, ref, push, onValue, set, remove, get, limitToLast } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js';
    import { getAuth, GoogleAuthProvider, TwitterAuthProvider, signInWithPopup, signInAnonymously, signOut } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBLMySLkXyeiL2_QLCdolHTOOA6W3TSfYc",
      authDomain: "gentle-brace-458923-k9.firebaseapp.com",
      databaseURL: "https://gentle-brace-458923-k9-default-rtdb.firebaseio.com",
      projectId: "gentle-brace-458923-k9",
      storageBucket: "gentle-brace-458923-k9.firebasestorage.app",
      messagingSenderId: "426876531009",
      appId: "1:426876531009:web:021b23c449bce5d72031c0",
      measurementId: "G-2B5KWNHYED"
    };

    try {
      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);
      const auth = getAuth(app);
      console.log('Firebase初期化成功');
      const messagesRef = ref(database, 'messages');
      const usersRef = ref(database, 'users');
      const adminsRef = ref(database, 'admins');
      const actionsRef = ref(database, 'actions');
      const bannedUsersRef = ref(database, 'bannedUsers');
      const kickedUsersRef = ref(database, 'kickedUsers');

      const formEl = document.getElementById('messageForm');
      const messagesEl = document.getElementById('messages');
      const inputEl = document.getElementById('m');
      const errorAlert = document.getElementById('error-alert');
      const loginBtn = document.getElementById('login-btn');
      const twitterLogin = document.getElementById('twitterLogin');
      const googleLogin = document.getElementById('googleLogin');
      const anonymousLogin = document.getElementById('anonymousLogin');
      const userInfo = document.getElementById('user-info');
      const unameModalEl = document.getElementById('unameModal');
      const unameModal = new bootstrap.Modal(unameModalEl);
      const loginModalEl = document.getElementById('loginModal');
      const loginModal = new bootstrap.Modal(loginModalEl);
      const unameInput = document.getElementById('uname');
      const confirmName = document.getElementById('confirmName');
      const signOutBtn = document.getElementById('signOut');
      const adminTrigger = document.getElementById('admin-trigger');
      const adminLoginModalEl = document.getElementById('adminLoginModal');
      const adminLoginModal = new bootstrap.Modal(adminLoginModalEl);
      const confirmAdmin = document.getElementById('confirmAdmin');
      const adminPanel = document.getElementById('adminPanel');
      const adminLogout = document.getElementById('adminLogout');
      const activeUsers = document.getElementById('activeUsers');
      const actionFilter = document.getElementById('actionFilter');
      const userActions = document.getElementById('userActions');
      const clearAllMessages = document.getElementById('clearAllMessages');
      const confirmActionModalEl = document.getElementById('confirmActionModal');
      const confirmActionModal = new bootstrap.Modal(confirmActionModalEl);
      const confirmActionMessage = document.getElementById('confirmActionMessage');
      const confirmActionBtn = document.getElementById('confirmActionBtn');
      const newMessageBtn = document.getElementById('newMessageBtn');

      let isAdmin = false;
      let isLoggingIn = false;
      let isUserScrolledUp = false;

      function showError(message) {
        errorAlert.textContent = message;
        errorAlert.classList.remove('d-none');
        setTimeout(() => errorAlert.classList.add('d-none'), 3000);
      }

      function showSuccess(message) {
        const successAlert = document.createElement('div');
        successAlert.className = 'alert alert-success';
        successAlert.setAttribute('role', 'alert');
        successAlert.textContent = message;
        document.body.appendChild(successAlert);
        setTimeout(() => successAlert.remove(), 3000);
      }

      async function updateUserUI(user) {
        try {
          if (user) {
            const userData = await get(ref(database, `users/${user.uid}`));
            const userDataVal = userData.val();
            const username = userDataVal?.username || user.displayName || 'ゲスト';
            userInfo.innerHTML = `${username} <i class="fas fa-pencil-alt ms-1"></i>`;
            loginBtn.textContent = 'ログアウト';
            loginModal.hide();
            loginModalEl.setAttribute('inert', '');
            if ((user.isAnonymous || !userDataVal?.username) && !isLoggingIn) {
              unameInput.value = userDataVal?.username || '';
              unameModalEl.removeAttribute('inert');
              unameModal.show();
              setTimeout(() => unameInput.focus(), 100);
            }
          } else {
            userInfo.innerHTML = 'ゲスト <i class="fas fa-pencil-alt ms-1"></i>';
            loginBtn.textContent = 'ログイン';
            adminPanel.classList.add('d-none');
            unameModalEl.setAttribute('inert', '');
            loginModalEl.removeAttribute('inert');
            loginModal.show();
            setTimeout(() => document.getElementById('twitterLogin').focus(), 100);
            isAdmin = false;
          }
        } catch (error) {
          console.error('ユーザーUI更新エラー:', error);
          showError('ユーザー情報の更新に失敗しました。');
        }
      }

      document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach((el) => {
        new bootstrap.Tooltip(el);
      });

      messagesEl.addEventListener('scroll', () => {
        const isAtBottom = Math.abs(messagesEl.scrollHeight - messagesEl.scrollTop - messagesEl.clientHeight) < 10;
        isUserScrolledUp = !isAtBottom;
        newMessageBtn.classList.toggle('d-none', !isUserScrolledUp);
      });

      newMessageBtn.addEventListener('click', () => {
        const lastMessage = messagesEl.lastElementChild;
        if (lastMessage) {
          lastMessage.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }
        isUserScrolledUp = false;
        newMessageBtn.classList.add('d-none');
      });

      twitterLogin.addEventListener('click', async () => {
        if (isLoggingIn) return;
        isLoggingIn = true;
        const provider = new TwitterAuthProvider();
        try {
          const result = await signInWithPopup(auth, provider);
          const user = result.user;
          const providerId = result.providerId || 'twitter.com';
          const existingUserData = (await get(ref(database, `users/${user.uid}`))).val();
          const username = existingUserData?.username || user.displayName || `user${Date.now()}`;
          await set(ref(database, `users/${user.uid}`), {
            username,
            provider: providerId,
            ipAddress: 'github'
          });
          await push(actionsRef, {
            type: 'connect',
            userId: user.uid,
            username,
            timestamp: Date.now()
          });
          console.log('Xログイン成功:', user.displayName);
          await updateUserUI(user);
          showSuccess('Xでログインしました。');
        } catch (error) {
          console.error('Xログインエラー:', error);
          showError('Xログインに失敗しました: ' + error.message);
        } finally {
          isLoggingIn = false;
        }
      });

      googleLogin.addEventListener('click', async () => {
        if (isLoggingIn) return;
        isLoggingIn = true;
        const provider = new GoogleAuthProvider();
        try {
          const result = await signInWithPopup(auth, provider);
          const user = result.user;
          const providerId = result.providerId || 'google.com';
          const existingUserData = (await get(ref(database, `users/${user.uid}`))).val();
          const username = existingUserData?.username || user.displayName || `user${Date.now()}`;
          await set(ref(database, `users/${user.uid}`), {
            username,
            provider: providerId,
            ipAddress: 'github'
          });
          await push(actionsRef, {
            type: 'connect',
            userId: user.uid,
            username,
            timestamp: Date.now()
          });
          console.log('Googleログイン成功:', user.displayName);
          await updateUserUI(user);
          showSuccess('Googleでログインしました。');
        } catch (error) {
          console.error('Googleログインエラー:', error);
          showError('Googleログインに失敗しました: ' + error.message);
        } finally {
          isLoggingIn = false;
        }
      });

      anonymousLogin.addEventListener('click', async () => {
        if (isLoggingIn) return;
        isLoggingIn = true;
        try {
          const result = await signInAnonymously(auth);
          const user = result.user;
          const uniqueUsername = `anon${Date.now()}`;
          await set(ref(database, `users/${user.uid}`), {
            username: uniqueUsername,
            provider: 'anonymous',
            ipAddress: 'github'
          });
          await push(actionsRef, {
            type: 'connect',
            userId: user.uid,
            username: uniqueUsername,
            timestamp: Date.now()
          });
          console.log('匿名ログイン成功');
          await updateUserUI(user);
          showSuccess('匿名でログインしました。');
        } catch (error) {
          console.error('匿名ログインエラー:', error);
          showError('匿名ログインに失敗しました: ' + error.message);
        } finally {
          isLoggingIn = false;
        }
      });

      loginBtn.addEventListener('click', async () => {
        console.log('loginBtnクリック: 現在のユーザー:', auth.currentUser);
        if (auth.currentUser) {
          try {
            await push(actionsRef, {
              type: 'logout',
              userId: auth.currentUser.uid,
              username: userInfo.textContent,
              timestamp: Date.now()
            });
            await signOut(auth);
            console.log('ログアウト成功');
            showSuccess('ログアウトしました。');
          } catch (error) {
            console.error('ログアウトエラー:', error);
            showError('ログアウトに失敗しました: ' + error.message);
          }
        } else {
          loginModalEl.removeAttribute('inert');
          loginModal.show();
          setTimeout(() => document.getElementById('twitterLogin').focus(), 100);
          console.log('ログインモーダル表示');
        }
      });

      signOutBtn.addEventListener('click', async () => {
        console.log('signOutBtnクリック: ログアウト開始');
        try {
          await push(actionsRef, {
            type: 'logout',
            userId: auth.currentUser.uid,
            username: userInfo.textContent,
            timestamp: Date.now()
          });
          await signOut(auth);
          unameModal.hide();
          unameModalEl.setAttribute('inert', '');
          document.getElementById('login-btn').focus();
          console.log('ログアウト成功');
          showSuccess('ログアウトしました。');
        } catch (error) {
          console.error('ログアウトエラー:', error);
          showError('ログアウトに失敗しました: ' + error.message);
        }
      });

      userInfo.addEventListener('click', async () => {
        if (auth.currentUser) {
          const userData = await get(ref(database, `users/${auth.currentUser.uid}`));
          unameInput.value = userData.val()?.username || '';
          unameModalEl.removeAttribute('inert');
          unameModal.show();
          setTimeout(() => unameInput.focus(), 100);
          console.log('unameModal表示: uname入力欄にフォーカス');
        } else {
          showError('ログインしてください。');
        }
      });

      confirmName.addEventListener('click', async () => {
        console.log('confirmNameクリック: 入力値=', unameInput.value);
        const username = unameInput.value.trim();
        if (username === '') {
          unameInput.classList.add('is-invalid');
          console.log('ユーザー名エラー: 空文字');
          return;
        }
        if (!auth.currentUser) {
          showError('ログインしてください。');
          console.log('ユーザー名エラー: 未ログイン');
          return;
        }
        try {
          console.log('ユーザー名設定試行: UID=', auth.currentUser.uid, 'username=', username);
          const userData = (await get(ref(database, `users/${auth.currentUser.uid}`))).val();
          await set(ref(database, `users/${auth.currentUser.uid}`), {
            username,
            provider: userData?.provider || 'anonymous',
            ipAddress: userData?.ipAddress || 'github'
          });
          await push(actionsRef, {
            type: 'setUsername',
            userId: auth.currentUser.uid,
            username,
            timestamp: Date.now()
          });
          userInfo.innerHTML = `${username} <i class="fas fa-pencil-alt ms-1"></i>`;
          unameModal.hide();
          unameInput.classList.remove('is-invalid');
          console.log('ユーザー名設定成功:', username);
          showSuccess('ユーザー名を更新しました。');
        } catch (error) {
          console.error('ユーザー名設定エラー:', error);
          showError('ユーザー名の保存に失敗しました: ' + error.message);
        }
      });

      confirmAdmin.addEventListener('click', async () => {
        if (!auth.currentUser) {
          showError('ログインしてください。');
          return;
        }
        try {
          const uid = auth.currentUser.uid;
          window.location.href = `https://trextacy.com/chat-admin/admin_login.php?uid=${uid}`;
        } catch (error) {
          console.error('Adminログインエラー:', error);
          showError('Adminログインに失敗しました: ' + error.message);
        }
      });

async function verifyAdminToken() {
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('admin_token');
  const uid = urlParams.get('uid');
  if (token && uid && auth.currentUser && auth.currentUser.uid === uid) {
    try {
      const response = await fetch(`https://trextacy.com/chat-admin/verify_token.php?token=${token}&uid=${uid}`);
      const result = await response.json();
      if (result.success) {
        adminPanel.classList.remove('d-none');
        adminLoginModal.hide();
        adminLoginModalEl.setAttribute('inert', '');
        isAdmin = true;
        showSuccess('Adminログインしました。');
        window.history.replaceState(null, '', window.location.pathname);
      } else {
        showError(result.error || '無効なトークンです。');
      }
    } catch (error) {
      console.error('トークン検証エラー:', error);
      showError('Admin認証に失敗しました: ' + error.message);
    }
  }
}

      adminLogout.addEventListener('click', async () => {
        try {
          await set(ref(database, `admins/${auth.currentUser.uid}`), null);
          await push(actionsRef, {
            type: 'adminLogout',
            userId: auth.currentUser.uid,
            username: userInfo.textContent,
            timestamp: Date.now()
          });
          adminPanel.classList.add('d-none');
          isAdmin = false;
          showSuccess('Adminログアウトしました。');
          console.log('Adminログアウト成功');
        } catch (error) {
          console.error('Adminログアウトエラー:', error);
          showError('Adminログアウトに失敗しました。');
        }
      });

      auth.onAuthStateChanged(async (user) => {
        try {
          console.log('認証状態変更:', user ? `ログイン済み (UID: ${user.uid})` : '未ログイン');
          await updateUserUI(user);
          if (user) {
            const adminSnapshot = await get(ref(database, `admins/${user.uid}`));
            isAdmin = adminSnapshot.exists() && adminSnapshot.val().active;
            if (isAdmin) {
              adminPanel.classList.remove('d-none');
            } else {
              adminPanel.classList.add('d-none');
              await verifyAdminToken();
            }
          } else {
            adminPanel.classList.add('d-none');
            isAdmin = false;
          }
        } catch (error) {
          console.error('認証状態変更エラー:', error);
          showError('認証状態の更新に失敗しました: ' + error.message);
        }
      });

      adminTrigger.addEventListener('click', () => {
        if (!auth.currentUser) {
          showError('ログインしてください。');
          return;
        }
        if (isAdmin) {
          adminPanel.classList.toggle('d-none');
        } else {
          adminLoginModalEl.removeAttribute('inert');
          adminLoginModal.show();
          setTimeout(() => document.getElementById('confirmAdmin').focus(), 100);
        }
      });

      onValue(usersRef, async (snapshot) => {
        try {
          if (snapshot.val()) {
            activeUsers.innerHTML = '';
            const banSnapshot = await get(ref(database, 'bannedUsers'));
            const bannedUsers = banSnapshot.val() || {};
            Object.entries(snapshot.val()).forEach(([uid, { username, provider, ipAddress }]) => {
              const isBanned = !!bannedUsers[uid];
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${username || '匿名'} ${isBanned ? '<i class="fas fa-ban text-danger ms-1" title="BAN済み"></i>' : ''}</td>
                <td>${provider || 'unknown'}</td>
                <td>${ipAddress || 'unknown'}</td>
                <td>
                  ${isBanned ? 
                    `<button class="btn btn-success btn-sm unban-user" data-uid="${uid}" data-username="${username || '匿名'}" data-bs-toggle="tooltip" title="BANを解除"><i class="fas fa-unlock"></i></button>` : 
                    `<button class="btn btn-warning btn-sm ban-user" data-uid="${uid}" data-username="${username || '匿名'}" data-bs-toggle="tooltip" title="ユーザーをBAN"><i class="fas fa-ban"></i></button>`}
                  <button class="btn btn-secondary btn-sm kick-user" data-uid="${uid}" data-username="${username || '匿名'}" data-bs-toggle="tooltip" title="ユーザーをKICK"><i class="fas fa-sign-out-alt"></i></button>
                </td>`;
              activeUsers.appendChild(tr);
            });
            document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach((el) => new bootstrap.Tooltip(el));
          }
        } catch (error) {
          console.error('アクティブユーザー取得エラー:', error);
          showError('アクティブユーザーの取得に失敗しました。');
        }
      });

      onValue(actionsRef, (snapshot) => {
        try {
          userActions.innerHTML = '';
          if (snapshot.val()) {
            const filter = actionFilter.value;
            Object.entries(snapshot.val()).forEach(([id, { type, username, timestamp }]) => {
              if (filter === 'all' || type === filter) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                  <td>${username || '匿名'}</td>
                  <td>${type}</td>
                  <td>${new Date(timestamp).toLocaleString('ja-JP')}</td>`;
                userActions.appendChild(tr);
              }
            });
          }
        } catch (error) {
          console.error('アクション履歴取得エラー:', error);
          showError('アクション履歴の取得に失敗しました。');
        }
      });

      actionFilter.addEventListener('change', () => {
        onValue(actionsRef, (snapshot) => {
          try {
            userActions.innerHTML = '';
            if (snapshot.val()) {
              const filter = actionFilter.value;
              Object.entries(snapshot.val()).forEach(([id, { type, username, timestamp }]) => {
                if (filter === 'all' || type === filter) {
                  const tr = document.createElement('tr');
                  tr.innerHTML = `
                    <td>${username || '匿名'}</td>
                    <td>${type}</td>
                    <td>${new Date(timestamp).toLocaleString('ja-JP')}</td>`;
                  userActions.appendChild(tr);
                }
              });
            }
          } catch (error) {
            console.error('アクション履歴フィルターエラー:', error);
            showError('アクション履歴のフィルタリングに失敗しました。');
          }
        });
      });

      clearAllMessages.addEventListener('click', async () => {
        if (!auth.currentUser) {
          showError('ログインしてください。');
          return;
        }
        if (!isAdmin) {
          showError('Admin権限が必要です。');
          return;
        }
        confirmActionMessage.textContent = 'すべてのメッセージをクリアしますか？';
        confirmActionBtn.onclick = async () => {
          try {
            await remove(messagesRef);
            await push(actionsRef, {
              type: 'clearAllMessages',
              userId: auth.currentUser.uid,
              username: userInfo.textContent,
              timestamp: Date.now()
            });
            showSuccess('全メッセージをクリアしました。');
            console.log('全メッセージクリア成功');
          } catch (error) {
            console.error('全メッセージクリアエラー:', error);
            showError('全メッセージのクリアに失敗しました。');
          }
          confirmActionModal.hide();
        };
        confirmActionModalEl.removeAttribute('inert');
        confirmActionModal.show();
        setTimeout(() => confirmActionBtn.focus(), 100);
      });

      document.addEventListener('click', async (e) => {
        confirmActionBtn.onclick = null;
        if (e.target.classList.contains('delete-message')) {
          const key = e.target.dataset.key;
          if (!isAdmin) {
            showError('Admin権限が必要です。');
            return;
          }
          confirmActionMessage.textContent = `このメッセージを削除しますか？`;
          confirmActionBtn.onclick = async () => {
            try {
              await remove(ref(database, `messages/${key}`));
              await push(actionsRef, {
                type: 'deleteMessage',
                userId: auth.currentUser.uid,
                messageId: key,
                username: userInfo.textContent,
                timestamp: Date.now()
              });
              showSuccess('メッセージを削除しました。');
              console.log('メッセージ削除成功: messageId=', key);
            } catch (error) {
              console.error('メッセージ削除エラー:', error);
              showError('メッセージ削除に失敗しました: ' + error.message);
            }
            confirmActionModal.hide();
          };
          confirmActionModalEl.removeAttribute('inert');
          confirmActionModal.show();
          setTimeout(() => confirmActionBtn.focus(), 100);
        } else if (e.target.classList.contains('ban-user')) {
          const uid = e.target.dataset.uid;
          const username = e.target.dataset.username;
          if (!isAdmin) {
            showError('Admin権限が必要です。');
            return;
          }
          confirmActionMessage.textContent = `${username} をBANしますか？`;
          confirmActionBtn.onclick = async () => {
            try {
              await set(ref(database, `bannedUsers/${uid}`), true);
              await push(actionsRef, {
                type: 'banUser',
                userId: auth.currentUser.uid,
                targetUserId: uid,
                username: userInfo.textContent,
                timestamp: Date.now()
              });
              showSuccess(`${username} をBANしました。`);
              console.log('BAN成功: userId=', uid);
            } catch (error) {
              console.error('BANエラー:', error);
              showError('BANに失敗しました: ' + error.message);
            }
            confirmActionModal.hide();
          };
          confirmActionModalEl.removeAttribute('inert');
          confirmActionModal.show();
          setTimeout(() => confirmActionBtn.focus(), 100);
        } else if (e.target.classList.contains('unban-user')) {
          const uid = e.target.dataset.uid;
          const username = e.target.dataset.username;
          if (!isAdmin) {
            showError('Admin権限が必要です。');
            return;
          }
          confirmActionMessage.textContent = `${username} のBANを解除しますか？`;
          confirmActionBtn.onclick = async () => {
            try {
              await remove(ref(database, `bannedUsers/${uid}`));
              await push(actionsRef, {
                type: 'unbanUser',
                userId: auth.currentUser.uid,
                targetUserId: uid,
                username: userInfo.textContent,
                timestamp: Date.now()
              });
              showSuccess(`${username} のBANを解除しました。`);
              console.log('BAN解除成功: userId=', uid);
            } catch (error) {
              console.error('BAN解除エラー:', error);
              showError('BAN解除に失敗しました: ' + error.message);
            }
            confirmActionModal.hide();
          };
          confirmActionModalEl.removeAttribute('inert');
          confirmActionModal.show();
          setTimeout(() => confirmActionBtn.focus(), 100);
        } else if (e.target.classList.contains('kick-user')) {
          const uid = e.target.dataset.uid;
          const username = e.target.dataset.username;
          if (!isAdmin) {
            showError('Admin権限が必要です。');
            return;
          }
          confirmActionMessage.textContent = `${username} をKICKしますか？`;
          confirmActionBtn.onclick = async () => {
            try {
              await set(ref(database, `kickedUsers/${uid}`), { timestamp: Date.now() });
              await push(actionsRef, {
                type: 'kickUser',
                userId: auth.currentUser.uid,
                targetUserId: uid,
                username: userInfo.textContent,
                timestamp: Date.now()
              });
              showSuccess(`${username} をKICKしました。`);
              console.log('KICK成功: userId=', uid);
            } catch (error) {
              console.error('KICKエラー:', error);
              showError('KICKに失敗しました: ' + error.message);
            }
            confirmActionModal.hide();
          };
          confirmActionModalEl.removeAttribute('inert');
          confirmActionModal.show();
          setTimeout(() => confirmActionBtn.focus(), 100);
        }
      });

      onValue(kickedUsersRef, (snapshot) => {
        try {
          if (auth.currentUser && snapshot.val()?.[auth.currentUser.uid]) {
            console.log('KICK検出: userId=', auth.currentUser.uid);
            signOut(auth).then(() => {
              console.log('KICKによりログアウト成功');
              showError('管理者によりログアウトされました。');
              set(ref(database, `kickedUsers/${auth.currentUser.uid}`), null).catch((error) => {
                console.error('KICKフラグ削除エラー:', error);
              });
            }).catch((error) => {
              console.error('KICKログアウトエラー:', error);
              showError('ログアウトに失敗しました: ' + error.message);
            });
          }
        } catch (error) {
          console.error('KICK監視エラー:', error);
          showError('KICK状態の監視に失敗しました。');
        }
      });

      onValue(ref(database, 'messages', limitToLast(50)), async (snapshot) => {
        try {
          console.log('データ取得: メッセージ数', snapshot.val() ? Object.keys(snapshot.val()).length : 0, 'isAdmin=', isAdmin);
          messagesEl.innerHTML = '';
          if (snapshot.val()) {
            const messages = Object.entries(snapshot.val());
            for (const [key, { username, message, timestamp, userId, ipAddress }] of messages) {
              const isOwnMessage = userId === (auth.currentUser?.uid || '');
              const isLatest = key === messages[messages.length - 1][0];
              const userData = await get(ref(database, `users/${userId}`));
              const provider = userData.val()?.provider || 'anonymous';
              const iconClass = provider === 'twitter.com' ? 'fa-brands fa-x-twitter' :
                               provider === 'google.com' ? 'fa-brands fa-google' :
                               'fa-solid fa-user-secret';
              const li = document.createElement('li');
              li.className = `list-group-item d-flex ${isOwnMessage ? 'justify-content-end' : 'justify-content-start'} align-items-start border-0 ${isLatest ? 'latest-message' : ''} fade-in`;
              const date = timestamp ? new Date(timestamp).toLocaleString('ja-JP') : '不明';
              li.innerHTML = `
                <div class="message ${isOwnMessage ? 'bg-primary text-white' : 'bg-light'} p-2 rounded shadow-sm">
                  <div class="message-header">
                    <i class="${iconClass} me-2 provider-icon"></i>
                    <strong>${username || '匿名'}</strong> <small class="text-muted">${date}</small>
                    ${isAdmin ? `<button class="btn btn-danger btn-sm ms-2 delete-message" data-key="${key}" data-bs-toggle="tooltip" title="メッセージを削除">削除</button>` : ''}
                  </div>
                  <div class="message-body">
                    ${message ? message.replace(/\n/g, '<br>') : 'メッセージなし'}
                  </div>
                </div>`;
              messagesEl.appendChild(li);
              setTimeout(() => li.style.opacity = '1', 100);
            }
            if (!isUserScrolledUp) {
              const lastMessage = messagesEl.lastElementChild;
              if (lastMessage) {
                lastMessage.scrollIntoView({ behavior: 'smooth', block: 'end' });
              }
              newMessageBtn.classList.add('d-none');
            } else {
              newMessageBtn.classList.remove('d-none');
            }
            document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach((el) => new bootstrap.Tooltip(el));
          }
        } catch (error) {
          console.error('メッセージ取得エラー:', error);
          showError('メッセージの取得に失敗しました。');
        }
      });

      formEl.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!formEl.checkValidity()) {
          e.stopPropagation();
          formEl.classList.add('was-validated');
          return;
        }
        if (!auth.currentUser) {
          showError('ログインしてください。');
          return;
        }
        const banned = (await get(ref(database, `bannedUsers/${auth.currentUser.uid}`))).val();
        if (banned) {
          showError('あなたはBANされています。メッセージを送信できません。');
          return;
        }
        const message = inputEl.value.trim();
        if (message.length === 0) {
          showError('メッセージを入力してください。');
          return;
        }
        if (message.length > 500) {
          showError('メッセージは500文字以内にしてください。');
          return;
        }
        try {
          const userData = (await get(ref(database, `users/${auth.currentUser.uid}`))).val();
          await push(messagesRef, {
            username: userInfo.textContent,
            message,
            timestamp: Date.now(),
            userId: auth.currentUser.uid,
            ipAddress: userData?.ipAddress || 'github'
          });
          await push(actionsRef, {
            type: 'sendMessage',
            userId: auth.currentUser.uid,
            username: userInfo.textContent,
            timestamp: Date.now()
          });
          inputEl.value = '';
          formEl.classList.remove('was-validated');
          isUserScrolledUp = false;
          const lastMessage = messagesEl.lastElementChild;
          if (lastMessage) {
            lastMessage.scrollIntoView({ behavior: 'smooth', block: 'end' });
          }
          newMessageBtn.classList.add('d-none');
        } catch (error) {
          console.error('メッセージ送信エラー:', error);
          showError('メッセージの送信に失敗しました: ' + error.message);
        }
      });

      inputEl.addEventListener('input', () => {
        inputEl.style.height = 'auto';
        inputEl.style.height = `${Math.min(inputEl.scrollHeight, 120)}px`;
      });

      unameModalEl.addEventListener('hidden.bs.modal', () => {
        unameModalEl.setAttribute('inert', '');
        document.getElementById('login-btn').focus();
        console.log('unameModal非表示: フォーカスをlogin-btnに移動');
      });
      adminLoginModalEl.addEventListener('hidden.bs.modal', () => {
        adminLoginModalEl.setAttribute('inert', '');
        document.getElementById('login-btn').focus();
        console.log('adminLoginModal非表示: フォーカスをlogin-btnに移動');
      });
      loginModalEl.addEventListener('hidden.bs.modal', () => {
        loginModalEl.setAttribute('inert', '');
        document.getElementById('login-btn').focus();
        console.log('loginModal非表示: フォーカスをlogin-btnに移動');
      });
      confirmActionModalEl.addEventListener('hidden.bs.modal', () => {
        confirmActionModalEl.setAttribute('inert', '');
        confirmActionBtn.onclick = null;
        document.getElementById('login-btn').focus();
        console.log('confirmActionModal非表示: フォーカスをlogin-btnに移動');
      });

      window.onload = () => {
        messagesEl.scrollTo({ top: messagesEl.scrollHeight, behavior: 'smooth' });
        console.log('ページロード: 最新メッセージにスクロール');
        verifyAdminToken();
      };

      if (Notification.permission !== 'granted') {
        Notification.requestPermission().then(permission => {
          if (permission === 'granted') {
            console.log('通知が許可されました');
          }
        });
      }
    } catch (error) {
      console.error('Firebase初期化エラー:', error);
      showError('Firebaseの初期化に失敗しました。');
    }
  </script>
</body>
</html>