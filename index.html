<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forrest Aura</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="/chat/icon.png" type="image/png">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
</head>
<body>
  <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="loginModalLabel">ログイン</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <button id="loginX" class="btn btn-primary w-100 mb-2"><i class="fab fa-x"></i> Xでログイン</button>
          <button id="loginGoogle" class="btn btn-danger w-100 mb-2"><i class="fab fa-google"></i> Googleでログイン</button>
          <button id="loginAnonymous" class="btn btn-secondary w-100"><i class="fas fa-user-secret"></i> 匿名でログイン</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="usernameModal" tabindex="-1" aria-labelledby="usernameModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="usernameModalLabel">ユーザー名設定</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="usernameInput" class="form-control" placeholder="名前を入力してください。" required>
          <div class="invalid-feedback">名前を入力してください。</div>
          <button id="setUsername" class="btn btn-primary w-100 mt-2">確定</button>
          <button id="logout" class="btn btn-danger w-100 mt-2">ログアウト</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="confirmActionModal" tabindex="-1" aria-labelledby="confirmActionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmActionModalLabel">アクション確認</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="confirmActionMessage"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" id="confirmActionBtn" class="btn btn-primary">実行</button>
        </div>
      </div>
    </div>
  </div>

  <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Forrest Aura</a>
      <div class="ms-auto d-flex align-items-center">
        <span id="user-info" class="cursor-pointer">ゲスト <i class="fas fa-pencil-alt ms-1"></i></span>
        <button id="loginBtn" class="btn btn-outline-primary ms-2">ログイン</button>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h3 class="mb-0">新着メッセージ</h3>
      </div>
      <div class="card-body" style="max-height: 500px; overflow-y: auto;">
        <div id="messages"></div>
      </div>
    </div>
  </div>

  <div class="container mt-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="input-group">
          <input type="text" id="messageInput" class="form-control" placeholder="メッセージを入力してください。">
          <button id="sendMessage" class="btn btn-primary"><i class="fas fa-paper-plane"></i> 送信</button>
        </div>
      </div>
    </div>
  </div>

  <div id="error-alert" class="alert alert-danger d-none" role="alert"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
    import { getDatabase, ref, push, onValue, set, remove } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js';
    import { getAuth, signInWithPopup, GoogleAuthProvider, TwitterAuthProvider, signInAnonymously, signOut } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBLMySLkXyeiL2_QLCdolHTOOA6W3TSfYc",
      authDomain: "gentle-brace-458923-k9.firebaseapp.com",
      databaseURL: "https://gentle-brace-458923-k9-default-rtdb.firebaseio.com",
      projectId: "gentle-brace-458923-k9",
      storageBucket: "gentle-brace-458923-k9.firebasestorage.app",
      messagingSenderId: "426876531009",
      appId: "1:426876531009:web:021b23c449bce5d72031c0",
      measurementId: "G-2B5KWNHYED"
    };

    try {
      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);
      const auth = getAuth(app);
      const messagesRef = ref(database, 'messages');
      const usersRef = ref(database, 'users');
      const actionsRef = ref(database, 'actions');
      const bannedUsersRef = ref(database, 'bannedUsers');
      const kickedUsersRef = ref(database, 'kickedUsers');

      const loginModalEl = document.getElementById('loginModal');
      const loginModal = new bootstrap.Modal(loginModalEl);
      const usernameModalEl = document.getElementById('usernameModal');
      const usernameModal = new bootstrap.Modal(usernameModalEl);
      const confirmActionModalEl = document.getElementById('confirmActionModal');
      const confirmActionModal = new bootstrap.Modal(confirmActionModalEl);
      const loginBtn = document.getElementById('loginBtn');
      const loginX = document.getElementById('loginX');
      const loginGoogle = document.getElementById('loginGoogle');
      const loginAnonymous = document.getElementById('loginAnonymous');
      const usernameInput = document.getElementById('usernameInput');
      const setUsername = document.getElementById('setUsername');
      const logout = document.getElementById('logout');
      const userInfo = document.getElementById('user-info');
      const messageInput = document.getElementById('messageInput');
      const sendMessage = document.getElementById('sendMessage');
      const messages = document.getElementById('messages');
      const confirmActionMessage = document.getElementById('confirmActionMessage');
      const confirmActionBtn = document.getElementById('confirmActionBtn');
      const errorAlert = document.getElementById('error-alert');

      function showError(message) {
        errorAlert.textContent = message;
        errorAlert.classList.remove('d-none');
        setTimeout(() => errorAlert.classList.add('d-none'), 3000);
      }

      function showSuccess(message) {
        const successAlert = document.createElement('div');
        successAlert.className = 'alert alert-success';
        successAlert.setAttribute('role', 'alert');
        successAlert.textContent = message;
        document.body.appendChild(successAlert);
        setTimeout(() => successAlert.remove(), 3000);
      }

      async function updateUserUI(user) {
        try {
          if (user) {
            const userData = await get(ref(database, `users/${user.uid}`));
            const userDataVal = userData.val();
            const username = userDataVal?.username || user.displayName || 'ゲスト';
            userInfo.innerHTML = `${username} <i class="fas fa-pencil-alt ms-1"></i>`;
            loginBtn.classList.add('d-none');
            usernameModalEl.removeAttribute('inert');
            usernameModal.show();
            setTimeout(() => usernameInput.focus(), 100);
            await push(actionsRef, {
              type: 'connect',
              userId: user.uid,
              username,
              timestamp: Date.now()
            });
          } else {
            userInfo.innerHTML = 'ゲスト <i class="fas fa-pencil-alt ms-1"></i>';
            loginBtn.classList.remove('d-none');
            messages.innerHTML = '';
          }
        } catch (error) {
          console.error('ユーザーUI更新エラー:', error);
          showError('ユーザー情報の更新に失敗しました。');
        }
      }

      loginBtn.addEventListener('click', () => {
        loginModalEl.removeAttribute('inert');
        loginModal.show();
      });

      loginX.addEventListener('click', async () => {
        try {
          await signInWithPopup(auth, new TwitterAuthProvider());
          loginModal.hide();
          loginModalEl.setAttribute('inert', '');
        } catch (error) {
          console.error('Xログインエラー:', error);
          showError('Xでのログインに失敗しました。');
        }
      });

      loginGoogle.addEventListener('click', async () => {
        try {
          await signInWithPopup(auth, new GoogleAuthProvider());
          loginModal.hide();
          loginModalEl.setAttribute('inert', '');
        } catch (error) {
          console.error('Googleログインエラー:', error);
          showError('Googleでのログインに失敗しました。');
        }
      });

      loginAnonymous.addEventListener('click', async () => {
        try {
          await signInAnonymously(auth);
          loginModal.hide();
          loginModalEl.setAttribute('inert', '');
        } catch (error) {
          console.error('匿名ログインエラー:', error);
          showError('匿名ログインに失敗しました。');
        }
      });

      setUsername.addEventListener('click', async () => {
        const username = usernameInput.value.trim();
        if (!username) {
          usernameInput.classList.add('is-invalid');
          return;
        }
        try {
          await set(ref(database, `users/${auth.currentUser.uid}`), {
            username,
            provider: auth.currentUser.providerData[0]?.providerId || 'anonymous',
            ipAddress: 'unknown' // サーバー側で取得推奨
          });
          userInfo.innerHTML = `${username} <i class="fas fa-pencil-alt ms-1"></i>`;
          usernameModal.hide();
          usernameModalEl.setAttribute('inert', '');
          showSuccess('ユーザー名を設定しました。');
          await push(actionsRef, {
            type: 'setUsername',
            userId: auth.currentUser.uid,
            username,
            timestamp: Date.now()
          });
        } catch (error) {
          console.error('ユーザー名設定エラー:', error);
          showError('ユーザー名の設定に失敗しました。');
        }
      });

      usernameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          setUsername.click();
        }
      });

      logout.addEventListener('click', () => {
        confirmActionMessage.textContent = 'ログアウトしますか？';
        confirmActionBtn.onclick = async () => {
          try {
            await signOut(auth);
            usernameModal.hide();
            usernameModalEl.setAttribute('inert', '');
            showSuccess('ログアウトしました。');
          } catch (error) {
            console.error('ログアウトエラー:', error);
            showError('ログアウトに失敗しました。');
          }
          confirmActionModal.hide();
        };
        confirmActionModalEl.removeAttribute('inert');
        confirmActionModal.show();
        setTimeout(() => confirmActionBtn.focus(), 100);
      });

      sendMessage.addEventListener('click', async () => {
        const message = messageInput.value.trim();
        if (!message) {
          messageInput.classList.add('is-invalid');
          return;
        }
        if (!auth.currentUser) {
          showError('ログインしてください。');
          return;
        }
        try {
          const userData = await get(ref(database, `users/${auth.currentUser.uid}`));
          const username = userData.val()?.username || 'ゲスト';
          await push(messagesRef, {
            userId: auth.currentUser.uid,
            username,
            message,
            timestamp: Date.now()
          });
          messageInput.value = '';
          messageInput.classList.remove('is-invalid');
          showSuccess('メッセージを送信しました。');
          await push(actionsRef, {
            type: 'sendMessage',
            userId: auth.currentUser.uid,
            username,
            timestamp: Date.now()
          });
        } catch (error) {
          console.error('メッセージ送信エラー:', error);
          showError('メッセージの送信に失敗しました。');
        }
      });

      messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendMessage.click();
        }
      });

      auth.onAuthStateChanged(async (user) => {
        try {
          console.log('認証状態変更:', user ? `ログイン済み (UID: ${user.uid})` : '未ログイン');
          await updateUserUI(user);
        } catch (error) {
          console.error('認証状態変更エラー:', error);
          showError('認証状態の更新に失敗しました。');
        }
      });

      onValue(bannedUsersRef, (snapshot) => {
        try {
          if (auth.currentUser && snapshot.val()?.[auth.currentUser.uid]) {
            console.log('BAN検出: userId=', auth.currentUser.uid);
            showError('あなたは管理者によりBANされています。');
            signOut(auth);
          }
        } catch (error) {
          console.error('BAN監視エラー:', error);
          showError('BAN状態の監視に失敗しました。');
        }
      });

      onValue(kickedUsersRef, (snapshot) => {
        try {
          if (auth.currentUser && snapshot.val()?.[auth.currentUser.uid]) {
            console.log('KICK検出: userId=', auth.currentUser.uid);
            showError('管理者によりログアウトされました。');
            signOut(auth);
          }
        } catch (error) {
          console.error('KICK監視エラー:', error);
          showError('KICK状態の監視に失敗しました。');
        }
      });

      let lastMessageId = null;
      onValue(messagesRef, (snapshot) => {
        try {
          if (snapshot.val()) {
            const newMessages = Object.entries(snapshot.val());
            // 最後のメッセージIDをチェックして重複追加を防止
            const lastNewMessageId = newMessages[newMessages.length - 1][0];
            if (lastMessageId === lastNewMessageId) return;

            newMessages.forEach(([id, { userId, username, message, timestamp }]) => {
              // 既に表示済みのメッセージはスキップ
              if (document.getElementById(`message-${id}`)) return;
              
              const messageElement = document.createElement('div');
              messageElement.id = `message-${id}`;
              messageElement.className = 'message mb-2';
              messageElement.innerHTML = `
                <div class="d-flex justify-content-between">
                  <strong>${username || '匿名'}</strong>
                  <small>${new Date(timestamp).toLocaleString('ja-JP')}</small>
                </div>
                <p class="mb-0">${message}</p>
                ${auth.currentUser && auth.currentUser.uid === userId ? 
                  `<button class="btn btn-danger btn-sm delete-message" data-id="${id}" data-bs-toggle="tooltip" title="メッセージを削除"><i class="fas fa-trash"></i></button>` : ''}`;
              messages.appendChild(messageElement);
              // 最新メッセージにスクロール
              messageElement.scrollIntoView({ behavior: 'smooth' });
            });
            lastMessageId = lastNewMessageId;
            document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach((el) => new bootstrap.Tooltip(el));
          }
        } catch (error) {
          console.error('メッセージ取得エラー:', error);
          showError('メッセージの取得に失敗しました。');
        }
      });

      document.addEventListener('click', async (e) => {
        if (e.target.classList.contains('delete-message')) {
          if (!auth.currentUser) {
            showError('ログインしてください。');
            return;
          }
          const messageId = e.target.dataset.id;
          confirmActionMessage.textContent = 'このメッセージを削除しますか？';
          confirmActionBtn.onclick = async () => {
            try {
              await remove(ref(database, `messages/${messageId}`));
              await push(actionsRef, {
                type: 'deleteMessage',
                userId: auth.currentUser.uid,
                username: userInfo.textContent,
                timestamp: Date.now()
              });
              showSuccess('メッセージを削除しました。');
            } catch (error) {
              console.error('メッセージ削除エラー:', error);
              showError('メッセージの削除に失敗しました。');
            }
            confirmActionModal.hide();
          };
          confirmActionModalEl.removeAttribute('inert');
          confirmActionModal.show();
          setTimeout(() => confirmActionBtn.focus(), 100);
        }
      });

      window.onload = () => {
        console.log('ページロード: チャット初期化');
        messages.innerHTML = '';
      };
    } catch (error) {
      console.error('Firebase初期化エラー:', error);
      showError('Firebaseの初期化に失敗しました。');
    }
  </script>
</body>
</html>