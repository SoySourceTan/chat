<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>TwitCasting Recorder in Browser</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.15"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/RecordRTC/5.6.2/RecordRTC.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #error { color: red; display: none; }
        #video { border: 1px solid #ccc; }
    </style>
</head>
<body>
    <h1>TwitCasting ライブ録画 (ブラウザ版)</h1>
    <input type="text" id="streamUrl" placeholder="TwitCasting HLS URL (例: https://twitcasting.tv/username/movie/xxxx.m3u8)" style="width: 400px;">
    <button onclick="loadStream()">ストリームロード</button>
    <br>
    <video id="video" controls autoplay muted width="640" height="360"></video>
    <br>
    <button id="startRecord" onclick="startRecording()" disabled>録画開始</button>
    <button id="stopRecord" onclick="stopRecording()" disabled>録画停止 & ダウンロード</button>
    <p id="error"></p>

    <script>
        let recorder;
        let video = document.getElementById('video');
        let hls;

        function showError(msg) {
            const errorDiv = document.getElementById('error');
            errorDiv.style.display = 'block';
            errorDiv.innerText = msg;
        }

        function loadStream() {
            const url = document.getElementById('streamUrl').value;
            if (!url) {
                showError('HLS URLを入力しろ。例: https://twitcasting.tv/username/movie/123456789.m3u8');
                return;
            }

            if (Hls.isSupported()) {
                hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    video.play().catch(e => showError('再生エラー: ' + e.message));
                    document.getElementById('startRecord').disabled = false;
                });
                hls.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        showError('HLSエラー: ' + data.details + '. CORSブロックの可能性。CORS Unblock拡張を使ってみろ: https://chrome.google.com/webstore/detail/cors-unblock');
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = url;
                video.addEventListener('loadedmetadata', () => {
                    video.play().catch(e => showError('再生エラー: ' + e.message));
                    document.getElementById('startRecord').disabled = false;
                });
                video.addEventListener('error', () => {
                    showError('ビデオエラー: CORSブロックの可能性。CORS Unblock拡張を使ってみろ: https://chrome.google.com/webstore/detail/cors-unblock');
                });
            } else {
                showError('HLSサポートなし。Chrome/Firefox/Edgeを使ってみろ');
            }
        }

        function startRecording() {
            const stream = video.captureStream();
            recorder = new RecordRTC(stream, {
                type: 'video',
                mimeType: 'video/webm',
                bitsPerSecond: 128000
            });
            recorder.startRecording();
            document.getElementById('startRecord').disabled = true;
            document.getElementById('stopRecord').disabled = false;
        }

        function stopRecording() {
            recorder.stopRecording(function() {
                const blob = recorder.getBlob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `twitcasting_${new Date().toISOString().replace(/[:.]/g, '-')}.webm`;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            });
            document.getElementById('startRecord').disabled = false;
            document.getElementById('stopRecord').disabled = true;
        }
    </script>
</body>
</html>